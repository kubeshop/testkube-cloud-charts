{{- if .Values.dex.configSecret.createCustom }}
apiVersion: "v1"
kind: "Secret"
metadata:
  name: {{ .Values.dex.configSecret.name }}
  labels:
    {{- include "testkube-enterprise.labels" . | nindent 4 }}
type: "Opaque"
stringData:
  {{- if .Values.dex.configTemplate.customConfig }}
  config.yaml: |-
    {{- .Values.dex.configTemplate.customConfig | nindent 4 }}
  {{- else }}
  config.yaml: |-
    {{- .Values.dex.configTemplate.base | nindent 4 }}
    storage:
      {{- if .Values.dex.storage }}
      {{- toYaml .Values.dex.storage | nindent 6 }}
      {{- else }}
        type: kubernetes
        config:
          inCluster: true
      {{- end }}
    {{- $api := index .Values "testkube-cloud-api"}}
    web:
      http: 0.0.0.0:5556
    expiry:
      deviceRequests: "5m"
      signingKeys: "6h"
      idTokens: "24h"
      refreshTokens:
        disableRotation: false
        reuseInterval: "3s"
        validIfNotUsedFor: "2160h" # 90 days
        absoluteLifetime: "3960h" # 165 days
    oauth2:
      responseTypes: ["code"]
      skipApprovalScreen: false
      alwaysShowLoginScreen: false
      passwordConnector: local
    issuer: http://localhost:5556
    staticClients:
      - id: {{ $api.api.oauth.clientId }}
        name: 'Testkube Enterprise'
        secret: '{{ $api.api.oauth.clientSecret }}'
        redirectURIs:
          - 'http://localhost:8090/auth/callback'
      - id: teskube-cloud-cli
        name: 'Testkube Enterprise CLI'
        secret: '{{ $api.api.oauth.clientSecret }}'
        redirectURIs:
          - 'http://localhost:8090/auth/callback'
      {{- if .Values.dex.configTemplate.additionalStaticClients }}
      {{- toYaml .Values.dex.configTemplate.additionalStaticClients | nindent 6 }}
      {{- end }}
    {{- if .Values.dex.configTemplate.additionalConfig }}
    {{ .Values.dex.configTemplate.additionalConfig | nindent 4 }}
    {{- end }}
  {{- end }}
{{- end }}
